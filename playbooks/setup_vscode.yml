---
- name: Install Visual Studio Code and VS Code extension on Ubuntu
  hosts: localhost
  become: yes
  tasks:
    - name: Check if VS Code is already installed
      command: dpkg-query -W code
      register: is_installed
      ignore_errors: yes
      changed_when: false

    - name: Download VS Code deb package if not installed
      get_url:
        url: https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64
        dest: /tmp/vscode.deb
      when: is_installed.rc != 0

    - name: Install VS Code package
      apt:
        deb: /tmp/vscode.deb
        state: present
      when: is_installed.rc != 0

    - name: Remove the VS Code deb package
      file:
        path: /tmp/vscode.deb
        state: absent
      when: is_installed.rc != 0

    - name: Check if VS Code YAML extension is installed
      command: code --list-extensions
      register: vscode_extensions
      become: no
      environment:
        HOME: "/home/{{ ansible_env.SUDO_USER }}"
        USER: "{{ ansible_env.SUDO_USER }}"
      changed_when: false

    - name: Install VS Code extension - redhat.vscode-yaml
      command: >
        code --install-extension redhat.vscode-yaml
        --no-sandbox
        --user-data-dir /home/{{ ansible_env.SUDO_USER }}/.vscode-root
      become: no
      environment:
        HOME: "/home/{{ ansible_env.SUDO_USER }}"
        USER: "{{ ansible_env.SUDO_USER }}"
      when: "'redhat.vscode-yaml' not in vscode_extensions.stdout"

    - name: Install VS Code extension - redhat.ansible
      command: >
        code --install-extension redhat.ansible
        --no-sandbox
        --user-data-dir /home/{{ ansible_env.SUDO_USER }}/.vscode-root
      become: no
      environment:
        HOME: "/home/{{ ansible_env.SUDO_USER }}"
        USER: "{{ ansible_env.SUDO_USER }}"
      when: "'redhat.ansible' not in vscode_extensions.stdout"
